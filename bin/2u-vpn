#!/bin/sh

set -e

ANYCONNECT_PREFIX=/opt/cisco/anyconnect
ONELOGIN_ITEM_ID=ok36jmwmuzf6pjjxmzzr64lxby

usage() {
    printf '2u vpn: usage: `2u vpn { connect | disconnect }`\n'
    exit 1
}

connect() {
    if ! op get item "$ONELOGIN_ITEM_ID" >/dev/null 2>&1; then
        printf 'vpn: cannot get OneLogin item, are you signed in?\n' >&2
        return 1
    fi
    (
        op get item "$ONELOGIN_ITEM_ID" |jq -r '.details.fields[] | select(.designation == "username") | .value'
        op get item "$ONELOGIN_ITEM_ID" |jq -r '.details.fields[] | select(.designation == "password") | .value'
        #op get totp "$ONELOGIN_ITEM_ID"
        printf y\\n
    ) | "$ANYCONNECT_PREFIX/bin/vpn" -s connect "2U Corp Network"
}

disconnect() {
    "$ANYCONNECT_PREFIX/bin/vpn" disconnect "2U Corp Network"
}


case "$1" in
connect)    connect ;;
disconnect) disconnect ;;
*)          usage ;;
esac
