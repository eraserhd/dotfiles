#!/usr/bin/env gxi

(import :std/text/json
        :std/misc/process
        :std/sugar)

(def laptop-display "143ABEAF-FB72-322D-E98C-F6A9BBDF00CA")

(def (yabai . args)
  (def (->arg x)
    (if (string? x)
      x
      (object->string x)))
  (run-process ["yabai" (map ->arg args) ...]))

(def (yabai-query . args)
  (run-process ["yabai" "-m" "query" args ...]
               coprocess: read-json))

(def (yabai-configure option value space: (space #f))
  (apply yabai "-m" "config" [(if space ["--space" space] []) ... option value]))

(def (get-laptop-display-number)
  (alet* ((displays (yabai-query "--displays"))
          (display  (find (lambda (display)
                            (string=? (hash-get display 'uuid) laptop-display))
                          displays)))
    (hash-get display 'index)))

(def (configure-laptop-space index)
  (yabai-configure space: index "layout" "float"))

(def (configure-monitor-space index)
  (yabai-configure space: index "layout" "bsp")
  (yabai-configure space: index "bottom_padding" 55))

(def (label-space index label)
  (yabai "-m" "space" index "--label" label))

(def (main)
  (def laptop-display-number (get-laptop-display-number))
  (def code-space #f)
  (def browse-space #f)
  (def meeting-space #f)
  (for-each (lambda (space)
              (let-hash space
                (if (= .display laptop-display-number)
                  (begin
                    (when (not browse-space)
                      (set! browse-space .index))
                    (configure-laptop-space .index))
                  (begin
                    (when (not code-space)
                      (set! code-space .index))
                    (configure-monitor-space .index)))))
            (yabai-query "--spaces"))
  (when code-space
    (label-space code-space "code"))
  (when browse-space
    (label-space browse-space "browse"))
  (when meeting-space
    (label-space meeting-space "meeting")))
