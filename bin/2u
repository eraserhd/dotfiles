#!/bin/sh

set -e

readonly ANYCONNECT_PREFIX=/opt/cisco/anyconnect
readonly ONELOGIN_ITEM_ID=ok36jmwmuzf6pjjxmzzr64lxby

#-----------------------------------------------------------------------------
#                            ** 1Passowrd Helpers **
#-----------------------------------------------------------------------------

unlock1p() {
    if [ -e ~/.1password ]; then
        source ~/.1password
    fi
    if ! op get item "$ONELOGIN_ITEM_ID" >/dev/null 2>&1; then
        if ! op signin >~/.1password; then
            printf '2u: unlock failed.\n' >&2
            exit 1
        fi
        source ~/.1password
    fi
}

#-----------------------------------------------------------------------------
#                            ** OneLogin Helpers **
#-----------------------------------------------------------------------------

oneLoginUser() {
    op get item "$ONELOGIN_ITEM_ID" |jq -r '.details.fields[] | select(.designation == "username") | .value'
}

oneLoginPassword() {
    op get item "$ONELOGIN_ITEM_ID" |jq -r '.details.fields[] | select(.designation == "password") | .value'
}

oneLoginOTP() {
    op get totp "$ONELOGIN_ITEM_ID"
}

#-----------------------------------------------------------------------------
#                                  ** VPN **
#-----------------------------------------------------------------------------

cmd_vpn_usage() {
    printf '2u vpn: usage: `2u vpn { connect | disconnect }`\n'
    exit 1
}

cmd_vpn_connect() {
    unlock1p
    (
        oneLoginUser
        oneLoginPassword
        sleep 120
        oneLoginOTP
        printf y\\n
    ) | "$ANYCONNECT_PREFIX/bin/vpn" -s connect "2U Corp Network"
}

cmd_vpn_disconnect() {
    "$ANYCONNECT_PREFIX/bin/vpn" disconnect "2U Corp Network"
}

cmd_vpn() {
    case "$1" in
    connect)    cmd_vpn_connect ;;
    disconnect) cmd_vpn_disconnect ;;
    *)          cmd_vpn_usage ;;
    esac
}

#-----------------------------------------------------------------------------
#                                ** Entry point **
#-----------------------------------------------------------------------------

main() {
    if [ -z "$1" ]; then
        printf '2u: usage is `2u subcommand [args ...]`\n' >&2
        exit 1
    fi

    command="$1"
    shift
    cmd_$command "$@"
}

main "$@"
