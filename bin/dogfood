#!/usr/bin/env bash

set -eo pipefail

rev=$(git rev-parse HEAD)
owner=eraserhd
repo=$(pwd)
repo=${repo##*/}

while [[ $# -gt 0 ]]; do
    case "$1" in
        -o|--owner) owner="$2"; shift;;
    esac
    shift
done

nix-prefetch-github --nix --rev "$rev" "$owner" "$repo" |
    sed -n -e '/fetchFromGitHub {/,/}/{
        s/^.*fetchFromGitHub //
        s/  //
        p
    }' > ~/src/dotfiles/dogfood/"$repo".nix

cd ~/src/dotfiles

if ! git grep -w "$repo"; then
    printf 'dogfood: %s: not mentioned anywhere in dotfiles.\n' >&2
    exit 1
fi

:r

git add dogfood/"$repo".nix
git commit -m "Bump ${repo}" dogfood/"$repo".nix
