#!/usr/bin/env bash

declare -a files=()
declare -a sessions=()

help() {
    printf 'Usage: kak-find-client [-s SESSION] [-f FILE]'
    exit 1
}

findKakfsRoot() {
    if [[ -n $XDG_RUNTIME_DIR ]]; then
        kakfs_root="${XDG_RUNTIME_DIR}/kakfs"
    else
        kakfs_root="${TMPDIR-/tmp}/kakfs/$USER"
    fi
}

addMountedSessions() {
    for session in "${kakfs_root}"/*; do
        if [[ -d ${session}/windows ]]; then
            sessions+=( "${session##*/}" )
        fi
    done
}

parseArgs() {
    while (( $# > 0 )); do
        case "$1" in
        -f|-file)
            shift
            files+=( "$(readlink -f "$1")" )
            ;;
        -s|-session)
            shift
            sessions+=( "$1" )
            ;;
        esac
        shift
    done
}

main() {
    parseArgs "$@"

    findKakfsRoot
    if (( ${#sessions[@]} == 0 )); then
        addMountedSessions
    fi

    for session in "${sessions[@]}"; do
        if [[ ! -d ${kakfs_root}/${session}/windows ]]; then
            continue
        fi
        for client_dir in "${kakfs_root}/${session}/windows"/*; do
            local client="${client_dir##*/}"

            if (( ${#files[@]} > 0 )); then
                local fileOk=false
                for file in "${files[@]}"; do
                    if [[ $file = $(cat "${client_dir}/buffile") ]]; then
                        fileOk=true
                        break
                    fi
                done
                if [[ $fileOk = false ]]; then
                    continue
                fi
            fi

            printf %s\\n "$client"
        done
    done
}

main "$@"
