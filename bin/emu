#!/usr/bin/env bash

cd ~

if [[ ! -f ~/parasite.qcow2 ]]; then
    qemu-img create -f qcow2 ~/parasite.qcow2 40G
fi
if [[ ! -f ~/nixos-install.iso ]]; then
    curl -Lo ~/nixos-install.iso https://channels.nixos.org/nixos-22.05/latest-nixos-minimal-x86_64-linux.iso
fi

#    -show-cursor \
#    -realtime mlock=off \
#
qemu-system-x86_64 \
    -enable-kvm \
    -display cocoa,full-grab=on,show-cursor=on,swap-opt-cmd=off \
    -M pc-q35-3.1,accel=hvf,usb=off,vmport=off \
    -cpu Penryn,kvm=on,vendor=GenuineIntel \
    -smp 4,sockets=1,cores=2,threads=2 \
    -m 8G \
    -rtc base=utc,driftfix=slew \
    -drive file=$PWD/parasite.qcow2,if=none,format=qcow2,id=disk0 \
    -device virtio-blk-pci,bus=pcie.0,addr=0x1,drive=disk0 \
    -netdev user,id=net0 \
    -device virtio-net-pci,netdev=net0,bus=pcie.0,addr=0x2 \
    -device virtio-keyboard-pci,bus=pcie.0,addr=0x3 \
    -device virtio-tablet-pci,bus=pcie.0,addr=0x4 \
    -device virtio-vga,bus=pcie.0,addr=0x5,max_outputs=2 \
    -cdrom $PWD/parasite2.iso \
    -boot d

