#!/usr/bin/env bash

ISO="$1"

cd ~

if [[ ! -f ~/parasite.qcow2 ]]; then
    qemu-img create -f qcow2 ~/parasite.qcow2 40G
fi

qemu-system-x86_64 \
    -enable-kvm \
    -display cocoa,full-grab=on,show-cursor=off,swap-opt-cmd=off \
    -M pc-q35-7.0,accel=hvf,usb=off,vmport=off \
    -cpu Penryn,kvm=on,vendor=GenuineIntel \
    -smp 4,sockets=1,cores=2,threads=2 \
    -m 8G \
    -rtc base=utc,driftfix=slew \
    -drive file=$PWD/parasite.qcow2,if=none,format=qcow2,id=disk0 \
    -device virtio-blk-pci,bus=pcie.0,addr=0x1,drive=disk0 \
    -netdev user,id=net0,hostfwd=tcp::5911-:5911 \
    -device virtio-net-pci,netdev=net0,bus=pcie.0,addr=0x2 \
    -device virtio-keyboard-pci,bus=pcie.0,addr=0x3 \
    -device virtio-tablet-pci,bus=pcie.0,addr=0x4 \
    -device virtio-vga,bus=pcie.0,addr=0x5,max_outputs=1 \
    -fsdev local,path=/Users/jfelice/src,security_model=passthrough,id=fsdev0 \
    -device virtio-9p-pci,id=fs0,fsdev=fsdev0,mount_tag=hostsrc \
    -cdrom "$ISO" \
    -boot d

