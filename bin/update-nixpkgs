#!/usr/bin/env gxi

(define (sh command-line)
  (display "#")
  (for-each (lambda (word)
              (display " ")
              (display word))
            command-line)
  (newline)
  (run-process command-line stdout-redirection: #f stderr-redirection: #f))

(define (update-branch branch)
  (sh '("git" "fetch" "upstream"))
  (sh `("git" "checkout" ,branch))
  (sh `("git" "reset" "--hard" ,(string-append "upstream/" branch)))
  (sh `("git" "push" "origin" ,branch)))

(define (update-nixpkgs)
  (parameterize ((current-directory "~/src/dotfiles/nixpkgs"))
    (update-branch "master"))
  (parameterize ((current-directory "~/src/dotfiles"))
    (sh '("nixos-rebuild" "build"))
    (sh '("git" "add" "nixpkgs"))
    (sh '("git" "commit" "-m" "Bump nixpkgs" "nixpkgs"))))

(define main update-nixpkgs)
